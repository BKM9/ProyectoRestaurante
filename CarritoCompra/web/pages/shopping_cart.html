<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Carrito de Compras - Sabores Auténticos</title>
        <link rel="stylesheet" href="../css/main.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Frestaurant9704back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
    </head>
    <body class="bg-background font-body">
        <!-- Header Navigation -->
        <header class="bg-white shadow-warm-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo -->
                    <div class="flex items-center">
                        <svg class="h-10 w-10 text-primary" viewBox="0 0 40 40" fill="currentColor">
                        <circle cx="20" cy="20" r="18" fill="currentColor" opacity="0.1"/>
                        <path d="M12 16h16v2H12v-2zm0 4h16v2H12v-2zm0 4h12v2H12v-2z" fill="currentColor"/>
                        <circle cx="20" cy="12" r="3" fill="currentColor"/>
                        </svg>
                        <span class="ml-3 text-xl font-sans font-bold text-primary">Sabores Auténticos</span>
                    </div>

                    <!-- Desktop Navigation -->
                    <nav class="hidden md:flex space-x-8">
                        <a href="restaurant_menu.jsp" class="text-text-secondary hover:text-primary transition-smooth">Menú</a>
                        <a href="table_reservation.html" class="text-text-secondary hover:text-primary transition-smooth">Reservas</a>
                        <a href="order_tracking.html" class="text-text-secondary hover:text-primary transition-smooth">Seguimiento</a>
                    </nav>

                    <!-- Cart Icon -->
                    <div class="flex items-center">
                        <button class="relative p-2 text-primary">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0h9"/>
                            </svg>
                            <span id="cartCount" class="absolute -top-1 -right-1 bg-secondary text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Breadcrumb -->
        <section class="bg-surface py-4">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex items-center space-x-2 text-sm">
                    <a href="restaurant_menu.jsp" class="text-text-secondary hover:text-primary transition-smooth">Menú</a>
                    <svg class="h-4 w-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <span class="text-primary font-medium">Carrito de Compras</span>
                </nav>
            </div>
        </section>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="lg:grid lg:grid-cols-3 lg:gap-8">
                <!-- Cart Items Section -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-warm p-6 mb-6">
                        <h1 class="text-2xl font-sans font-bold text-primary mb-6 flex items-center">
                            <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0h9"/>
                            </svg>
                            Tu Carrito
                        </h1>

                        <!-- Empty Cart Message -->
                        <div id="emptyCart" class="text-center py-12" style="display: none;">
                            <svg class="h-16 w-16 text-text-secondary mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0h9"/>
                            </svg>
                            <h3 class="text-lg font-semibold text-text-primary mb-2">Tu carrito está vacío</h3>
                            <p class="text-text-secondary mb-6">Añade algunos platos deliciosos para comenzar tu pedido</p>
                            <a href="restaurant_menu.jsp" class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary-600 transition-smooth">
                                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                Explorar Menú
                            </a>
                        </div>

                        <!-- Cart Items -->
                        <div id="cartItems" class="space-y-4">
                            <!-- Cart items will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Special Instructions -->
                    <div class="bg-white rounded-xl shadow-warm p-6 mb-6">
                        <h3 class="text-lg font-semibold text-primary mb-4 flex items-center">
                            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Instrucciones Especiales
                        </h3>
                        <textarea id="specialInstructions" placeholder="¿Alguna preferencia especial? Déjanos saber aquí..." class="w-full p-4 border border-warm rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none" rows="3"></textarea>
                    </div>
                </div>

                <!-- Order Summary Section -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-warm p-6 sticky top-24">
                        <h2 class="text-xl font-semibold text-primary mb-6">Resumen del Pedido</h2>

                        <!-- Delivery/Pickup Options -->
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-text-primary mb-3">Método de Entrega</h3>
                            <div class="space-y-3">
                                <label class="flex items-center p-3 border border-warm rounded-lg cursor-pointer hover:bg-surface transition-smooth">
                                    <input type="radio" name="deliveryMethod" value="delivery" class="text-primary focus:ring-primary" checked />
                                    <div class="ml-3 flex-1">
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium text-text-primary">Entrega a Domicilio</span>
                                            <span class="text-sm text-text-secondary">S/. 5,50</span>
                                        </div>
                                        <p class="text-xs text-text-secondary mt-1">30-45 min</p>
                                    </div>
                                </label>
                                <label class="flex items-center p-3 border border-warm rounded-lg cursor-pointer hover:bg-surface transition-smooth">
                                    <input type="radio" name="deliveryMethod" value="pickup" class="text-primary focus:ring-primary" />
                                    <div class="ml-3 flex-1">
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium text-text-primary">Recoger en Tienda</span>
                                            <span class="text-sm text-accent">Gratis</span>
                                        </div>
                                        <p class="text-xs text-text-secondary mt-1">15-20 min</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Delivery Address -->
                        <div id="deliveryAddress" class="mb-6">
                            <h3 class="text-sm font-medium text-text-primary mb-3">Dirección de Entrega</h3>
                            <div class="space-y-3">
                                <input type="text" id="addressLine1" placeholder="Dirección" class="w-full p-3 border border-warm rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" />
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="text" id="postalCode" placeholder="Código Postal" class="p-3 border border-warm rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" />
                                    <input type="text" id="city" placeholder="Ciudad" class="p-3 border border-warm rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" />
                                </div>
                            </div>
                        </div>

                        <!-- Pickup Address -->
                        <div id="pickupAddress" class="mb-6" style="display: none;">
                            <h3 class="text-sm font-medium text-text-primary mb-3">Dirección del Restaurante</h3>
                            <div class="p-3 bg-surface rounded-lg">
                                <p class="text-sm text-text-primary font-medium">Sabores Auténticos</p>
                                <p class="text-sm text-text-secondary">Av. Los Tulipanes 433</p>
                                <p class="text-sm text-text-secondary">28001 San Borja, Peru</p>
                                <p class="text-xs text-accent mt-2">Tiempo estimado: 15-20 min</p>
                            </div>
                        </div>

                        <!-- Promotional Code -->
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-text-primary mb-3">Código Promocional</h3>
                            <div class="flex space-x-2">
                                <input type="text" id="promoCode" placeholder="Ingresa tu código" class="flex-1 p-3 border border-warm rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" />
                                <button id="applyPromo" class="px-4 py-3 bg-secondary text-white rounded-lg font-medium hover:bg-secondary-600 transition-smooth">
                                    Aplicar
                                </button>
                            </div>
                            <div id="promoMessage" class="mt-2 text-sm" style="display: none;"></div>
                        </div>

                        <!-- Order Summary -->
                        <div class="border-t border-warm pt-4 space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Subtotal</span>
                                <span id="subtotal" class="text-text-primary">S/. 0,00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Entrega</span>
                                <span id="deliveryFee" class="text-text-primary">S/. 5,50</span>
                            </div>
                            <div id="discountRow" class="flex justify-between text-sm text-accent" style="display: none;">
                                <span>Descuento</span>
                                <span id="discountAmount">-S/. 0,00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">IGV (18%)</span>
                                <span id="taxAmount" class="text-text-primary">S/. 0,00</span>
                            </div>
                            <div class="border-t border-warm pt-3">
                                <div class="flex justify-between text-lg font-semibold">
                                    <span class="text-text-primary">Total</span>
                                    <span id="totalAmount" class="text-primary">S/. 0,00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Checkout Button -->
                        <button id="checkoutBtn" class="w-full mt-6 py-4 bg-secondary text-white rounded-lg font-semibold text-lg hover:bg-secondary-600 transition-smooth disabled:opacity-50 disabled:cursor-not-allowed">
                            Proceder al Pago
                        </button>

                        <!-- Continue Shopping -->
                        <a href="restaurant_menu.jsp" class="block text-center mt-4 text-primary hover:text-primary-600 transition-smooth">
                            Continuar Comprando
                        </a>
                    </div>
                </div>
            </div>
        </main>

        <!-- Fixed Mobile Checkout Button -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-warm p-4 lg:hidden z-30">
            <button id="mobileCheckoutBtn" class="w-full py-4 bg-secondary text-white rounded-lg font-semibold text-lg hover:bg-secondary-600 transition-smooth disabled:opacity-50 disabled:cursor-not-allowed">
                Proceder al Pago - <span id="mobileTotal">S/. 0,00</span>
            </button>
        </div>

        <!-- Remove Item Modal -->
        <div id="removeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4">
                <h3 class="text-lg font-semibold text-text-primary mb-4">Eliminar Artículo</h3>
                <p class="text-text-secondary mb-6">¿Estás seguro de que quieres eliminar este artículo del carrito?</p>
                <div class="flex space-x-3">
                    <button id="cancelRemove" class="flex-1 py-2 px-4 border border-gray-300 rounded-lg font-medium hover:bg-gray-50 transition-smooth">
                        Cancelar
                    </button>
                    <button id="confirmRemove" class="flex-1 py-2 px-4 bg-error text-white rounded-lg font-medium hover:bg-error-600 transition-smooth">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Cart functionality
            let cart = JSON.parse(localStorage.getItem('restaurantCart')) || [];
            let itemToRemove = null;
            let appliedDiscount = 0;

            // Sample cart data for demonstration
            if (cart.length === 0) {
                cart = [
                    {
                        name: "Ensalada Mediterránea",
                        price: 8.50,
                        quantity: 1,
                        image: "https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=600",
                        customizations: ["Sin cebolla", "Extra aceitunas"]
                    },
                    {
                        name: "Paella Valenciana",
                        price: 24.90,
                        quantity: 1,
                        image: "https://images.pexels.com/photos/725991/pexels-photo-725991.jpeg?auto=compress&cs=tinysrgb&w=600",
                        customizations: ["Para 2 personas"]
                    },
                    {
                        name: "Tiramisú Casero",
                        price: 6.90,
                        quantity: 2,
                        image: "https://images.pexels.com/photos/291528/pexels-photo-291528.jpeg?auto=compress&cs=tinysrgb&w=600",
                        customizations: []
                    }
                ];
                localStorage.setItem('restaurantCart', JSON.stringify(cart));
            }

            // Render cart items
            function renderCartItems() {
                const cartItemsContainer = document.getElementById('cartItems');
                const emptyCart = document.getElementById('emptyCart');

                if (cart.length === 0) {
                    cartItemsContainer.style.display = 'none';
                    emptyCart.style.display = 'block';
                    return;
                }

                cartItemsContainer.style.display = 'block';
                emptyCart.style.display = 'none';

                cartItemsContainer.innerHTML = cart.map((item, index) => `
                    <div class="flex items-start space-x-4 p-4 border border-warm rounded-lg">
                        <div class="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0">
                            <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover"
                                 onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-text-primary">${item.name}</h4>
                            ${item.customizations && item.customizations.length > 0 ?
                            `<p class="text-sm text-text-secondary mt-1">${item.customizations.join(', ')}</p>` : ''}
                            <div class="flex items-center justify-between mt-3">
                                <div class="flex items-center space-x-3">
                                    <button onclick="updateQuantity(${index}, -1)" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-lg font-bold hover:bg-gray-300 transition-smooth">-</button>
                                    <span class="font-semibold text-primary">${item.quantity}</span>
                                    <button onclick="updateQuantity(${index}, 1)" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-lg font-bold hover:bg-gray-300 transition-smooth">+</button>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="font-semibold text-primary">S/. ${(item.price * item.quantity).toFixed(2).replace('.', ',')}</span>
                                    <button onclick="showRemoveModal(${index})" class="text-error hover:text-error-600 transition-smooth">
                                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Update quantity
            function updateQuantity(index, change) {
                cart[index].quantity += change;
                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1);
                }
                localStorage.setItem('restaurantCart', JSON.stringify(cart));
                renderCartItems();
                updateOrderSummary();
            }

            // Show remove modal
            function showRemoveModal(index) {
                itemToRemove = index;
                document.getElementById('removeModal').style.display = 'flex';
            }

            // Remove item
            function removeItem() {
                if (itemToRemove !== null) {
                    cart.splice(itemToRemove, 1);
                    localStorage.setItem('restaurantCart', JSON.stringify(cart));
                    renderCartItems();
                    updateOrderSummary();
                    itemToRemove = null;
                }
                document.getElementById('removeModal').style.display = 'none';
            }

            // Update order summary
            function updateOrderSummary() {
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
                const deliveryFee = deliveryMethod === 'delivery' ? 5.50 : 0;
                const discountAmount = subtotal * (appliedDiscount / 100);
                const taxableAmount = subtotal - discountAmount;
                const tax = taxableAmount * 0.18;
                const total = taxableAmount + tax + deliveryFee;

                document.getElementById('subtotal').textContent = `S/. ${subtotal.toFixed(2).replace('.', ',')}`;
                document.getElementById('deliveryFee').textContent = deliveryFee > 0 ? `S/. ${deliveryFee.toFixed(2).replace('.', ',')}` : 'Gratis';
                document.getElementById('taxAmount').textContent = `S/. ${tax.toFixed(2).replace('.', ',')}`;
                document.getElementById('totalAmount').textContent = `S/. ${total.toFixed(2).replace('.', ',')}`;
                document.getElementById('mobileTotal').textContent = `S/. ${total.toFixed(2).replace('.', ',')}`;
                document.getElementById('cartCount').textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

                if (appliedDiscount > 0) {
                    document.getElementById('discountRow').style.display = 'flex';
                    document.getElementById('discountAmount').textContent = `-S/. ${discountAmount.toFixed(2).replace('.', ',')}`;
                } else {
                    document.getElementById('discountRow').style.display = 'none';
                }

                // Enable/disable checkout buttons
                const hasItems = cart.length > 0;
                document.getElementById('checkoutBtn').disabled = !hasItems;
                document.getElementById('mobileCheckoutBtn').disabled = !hasItems;
            }

            // Delivery method change
            document.querySelectorAll('input[name="deliveryMethod"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const deliveryAddress = document.getElementById('deliveryAddress');
                    const pickupAddress = document.getElementById('pickupAddress');

                    if (this.value === 'delivery') {
                        deliveryAddress.style.display = 'block';
                        pickupAddress.style.display = 'none';
                    } else {
                        deliveryAddress.style.display = 'none';
                        pickupAddress.style.display = 'block';
                    }
                    updateOrderSummary();
                });
            });

            // Promo code functionality
            document.getElementById('applyPromo').addEventListener('click', function () {
                const promoCode = document.getElementById('promoCode').value.trim().toUpperCase();
                const promoMessage = document.getElementById('promoMessage');

                // Sample promo codes
                const promoCodes = {
                    'DESCUENTO10': 10,
                    'BIENVENIDO': 15,
                    'VERANO2025': 20
                };

                if (promoCodes[promoCode]) {
                    appliedDiscount = promoCodes[promoCode];
                    promoMessage.textContent = `¡Código aplicado! ${appliedDiscount}% de descuento`;
                    promoMessage.className = 'mt-2 text-sm text-accent';
                    promoMessage.style.display = 'block';
                    this.textContent = 'Aplicado';
                    this.disabled = true;
                    this.classList.add('bg-accent', 'hover:bg-accent');
                    this.classList.remove('bg-secondary', 'hover:bg-secondary-600');
                } else {
                    promoMessage.textContent = 'Código promocional no válido';
                    promoMessage.className = 'mt-2 text-sm text-error';
                    promoMessage.style.display = 'block';
                }
                updateOrderSummary();
            });

            // Checkout functionality
            function proceedToCheckout() {
                if (cart.length === 0)
                    return;

                // Save order details to localStorage
                const orderDetails = {
                    items: cart,
                    deliveryMethod: document.querySelector('input[name="deliveryMethod"]:checked').value,
                    specialInstructions: document.getElementById('specialInstructions').value,
                    promoCode: appliedDiscount > 0 ? document.getElementById('promoCode').value : null,
                    discount: appliedDiscount
                };

                if (orderDetails.deliveryMethod === 'delivery') {
                    orderDetails.address = {
                        line1: document.getElementById('addressLine1').value,
                        postalCode: document.getElementById('postalCode').value,
                        city: document.getElementById('city').value
                    };
                }

//                const pedido = {
//                    numPedido: "PED-" + Date.now(), // Generamos un número único
//                    mtoTotal: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
//                    direccionEnvio: document.getElementById('addressLine1')?.value || "Recojo en tienda",
//                    metodoPago: document.querySelector('input[name="paymentMethod"]:checked')?.value || "efectivo",
//                    fechaRegistro: new Date().toISOString(), // compatible con java.util.Date
//                    cancelado: "N"
//                };
//
//                fetch("http://localhost:8082/api/restaurante/registrarPedido", {
//                    method: "POST",
//                    headers: {
//                        "Content-Type": "application/json"
//                    },
//                    body: JSON.stringify(pedido)
//                })
//                        .then(response => response.text())
//                        .then(data => {
//                            console.log("✅ Pedido enviado:", data);
//                            alert("Pedido registrado con éxito");
//                            window.location.href = 'payment_processing.html';
//                        })
//                        .catch(error => console.error("❌ Error al registrar pedido:", error));
                
                localStorage.setItem('orderDetails', JSON.stringify(orderDetails));
                window.location.href = 'payment_processing.html';
            }

            document.getElementById('checkoutBtn').addEventListener('click', proceedToCheckout);
            document.getElementById('mobileCheckoutBtn').addEventListener('click', proceedToCheckout);

            // Modal event listeners
            document.getElementById('cancelRemove').addEventListener('click', function () {
                document.getElementById('removeModal').style.display = 'none';
                itemToRemove = null;
            });

            document.getElementById('confirmRemove').addEventListener('click', removeItem);

            // Initialize
            renderCartItems();
            updateOrderSummary();
        </script>
        <script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
    </body>
</html>